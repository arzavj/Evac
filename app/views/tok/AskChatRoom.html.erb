  <script src="http://staging.tokbox.com/v0.91/js/TB.min.js"></script>
	<script type="text/javascript" src ="/javascripts/jquery.js"></script>

  <%= javascript_tag do %>


    var apiKey = '<%= $apiKey %>';
    var sessionId = '<%= @sessionID %>';
    var token = '<%= @token %>';           

	<% puts "Variables" %>
	<% puts $apiKey %>
	<% puts @sessionID %>
	<% puts @token %>
 
    TB.setLogLevel(TB.DEBUG); // Set this for helpful debugging messages in console
 
    var session = TB.initSession(sessionId);      
    session.addEventListener("sessionConnected", sessionConnectedHandler);      
    session.addEventListener("streamCreated", streamCreatedHandler); 

    session.connect(apiKey, token);
	
	var inSession = 0;
	
	window.onbeforeunload = function (){
		if(inSession){
			alert ("Your session is over");
		}
		else{
			alert ("Don't leave");
			var query = "qID="+<%=params["qID"]%>;
			
			$.ajax({
			type: 'POST',
			url: '/tok/submitStatus',
			data: query
			});

			
			//$.get("submitStatus?qID=" + );
						
			//submitChatRoomStatus();
		}
	}
	
	function submitChatRoomStatus(){
		var ajaxRequest;  // The variable that makes Ajax possible!
	
		try{
			// Opera 8.0+, Firefox, Safari
			ajaxRequest = new XMLHttpRequest();
		} catch (e){
			// Internet Explorer Browsers
			try{
				ajaxRequest = new ActiveXObject("Msxml2.XMLHTTP");
			} catch (e) {
				try{
					ajaxRequest = new ActiveXObject("Microsoft.XMLHTTP");
				} catch (e){
					// Something went wrong
					alert("Your browser broke!");
					return false;
				}
			}
		}
		
		ajaxRequest.onreadystatechange = function(){
			if(ajaxRequest.readyState == 4){
			}
		}

		

		var queryString = "?qID=" + <%=params["qID"] %>;
//		window.open("/tok/submitStatus" + queryString);
		ajaxRequest.open("GET", "/tok/submitStatus" + queryString, true);
		ajaxRequest.send(null); 
	}

	
    var publisher;
 
    function sessionConnectedHandler(event) {
	alert('Ready');
      publisher = session.publish("asker");
    }

   function streamCreatedHandler(event) {
      // Subscribe to any new streams that are created
      subscribeToStreams(event.streams);
    }
    
    function createForm(){
        var form = document.getElementById("rank");
               
        var submit = document.createElement("input");
        submit.setAttribute("type", "submit");
        submit.setAttribute("value", "Rank");
        
        form.appendChild(submit);
    }
     
    function subscribeToStreams(streams) {
      for (var i = 0; i < streams.length; i++) {
        // Make sure we don't subscribe to ourself
        if (streams[i].connection.connectionId == session.connection.connectionId) {
          continue;
        }
 
        // Create the div to put the subscriber element in to
        // var div = document.createElement('div');
        // div.setAttribute('id', 'stream' + streams[i].streamId);
        // document.body.appendChild(div);
                           
        // Subscribe to the stream
        session.subscribe(streams[i], "answer");
		
        //elem = document.getElementById("appointment");
        //elem.parentNode.removeChild(elem);
		
        createForm();
		inSession = 1;
        return;
      }
	  
	}

<%end%>
 
<center>
  <div id="asker"></div>
  <div id="answer"></div>
</center>


<form id="rank" action="/tok/SetRank" method= "get">
</form>
