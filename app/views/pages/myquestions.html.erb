<%if params["offline"]%>
<script type ="text/javascript">
	alert("It seems that that user has gone offline");
</script>
<%end%>

<%if params["schedule"].to_i == 1%> 
<script type ="text/javascript">
	alert('Your choices were sent');
	</script>
<%end%>

<%if params["sent"]%>
<script type ="text/javascript">
	alert("Your preference has been saved");
</script>
<%end%>


<script type ="text/javascript">
	function checkForm(formNumber)
	{
		var radios = document.getElementsByName("appointment" + formNumber);
		var value = true;
		for (var i = 0; i < radios.length; i++) {
			if (radios[i].type === 'radio' && radios[i].checked) {
				value = false;
				break;
			}
		}

		
		if (value)
		{
			alert("Please select one schedule");
			return false;
		}
		else
		{
			f.submit();
			return true;
		}
	}
</script>

<div class="transparent-background">
	<div class="body-wrapper">
		<div class="tabbable" id="myconversations">
			<ul class="nav nav-tabs">
		  		<li class="active"><a href="#upcoming" data-toggle="tab">Upcoming Conversations</a></li>
		  		<li><a href="#past" data-toggle="tab">Past Conversations</a></li>
			</ul>
			
			
			<div class="tab-content">
				<div class="tab-pane fade in active" id="upcoming">
					<div class="row-fluid">
						<div class="span6">
							<ul class="nav nav-list right-border">
							<!-- Questions that have been proposed to discuss -->
							<li><h3 class="SmallFont">Pending Conversations</h3></li>
							<li class="divider"></li>
							<%if @qPending.length == 0 && @qConfirmed.length==0%> 
								No upcoming conversations...
							<%end%>
						
						<%count = 0%>
						<% @qPending.each do |q| %>
						
							<li><span class="questions"><%=q.question%></span> <!-- If a pending question, it must have a answerer -->
								<%if q.answer_id != nil%>
									<%if @user.id == q.user_id%>
										<%id = q.answer_id%>
									<%else%>
										<%id = q.user_id%>
									<%end%>
									<%user = User.find(id)%>
									<%name = user.firstName + " " + user.lastName%>
									with <a class="question-username" href="/bio?id=<%=id%>"><%=name%></a>
								<%end%>
								<br />
								
							<%if q.schedules.any? && q.schedules[0].user_id != @user.id %>
								<%count = count + 1%>
								<form class="margin-bottom-5" action="/tok/AcceptSchedule" method= "get" onSubmit="return checkForm(<%=count.to_s%>);">
									<input type = "hidden" name = "qID" value = "<%= q.id %>" />
									<input type = "hidden" name = "count" value = "<%=count.to_s%>">
										<% q.schedules.each do |appointment|%> <!-- Set up form -->
										<input type="radio" name="appointment<%=count%>" value="<%=appointment.id%>" /> <div name="timeDiv"><%=appointment.appointment.strftime("%B %d, %Y %H:%M:%S UTC")%></div>
											<br />
										<%end%>
									
									<input class="btn" type="submit" value="Confirm Schedule" />
								</form>
							
								<form action="/tok/ScheduleAppointment" method= "get"> <!-- Ability to propose a schedule -->
									<input type = "hidden" name = "qID" value = "<%= q.id %>" />
									<input class="btn" type="submit" value="Propose Alternate Schedule" />
								</form>
							<%else%>
								Waiting for conversation to be scheduled...
							<%end%>	
							</li>
							<li class="divider"></li>
							
						<%end%>
						</ul>
						</div>
						
						<!-- DIVIDE OCCURS HERE -->
						
						<div class="span6">
							<ul class="nav nav-list">
								<li><h3 class="SmallFont">Confirmed Conversations</h3></li>
								<li class="divider"></li>
						
						<%@qConfirmed.each do |q|%>
							<li><span class="questions"><%=q.question%></span>
									<%if @user.id == q.user_id%>
										<%id = q.answer_id%>
									<%else%>
										<%id = q.user_id%>
									<%end%>
									<%user = User.find(id)%>
									<%name = user.firstName + " " + user.lastName%>
									with <a class="question-username" href="/bio?id=<%=id%>"><%=name%></a><br>
							
							
								<%s = Schedule.find(q.schedule_id)%>
								<br>You are scheduled to meet at <div name="timeDiv" ><%=s.appointment.strftime("%B %d, %Y %H:%M:%S UTC")%> </div>
								<%schedule = s.appointment - (5.minutes)%> <!--5 minutes before hand-->
								<%if schedule.past?%>
									<%if q.in_session == false%>
										<%str = "Enter Room For Appointment"%>
									<%else%>
										<%str = "Your Conversation is Ready"%>
									<%end%>
									
									<form class="margin-bottom-5" action="/tok/EnterSession" method= "get">
										<input type = "hidden" name = "qID" value = "<%= q.id %>" />
										<input type = "hidden" name = "uID" value = "<%= @user.id %>" />
										<input class="btn" type="submit" value="Enter Room For Appointment" />
									</form>			
								<%else%>
										<div class="margin-bottom-5"><input class="btn disabled enter-chatroom-tooltip" rel="tooltip" title="Please return 5 minutes prior to scheduled time" type="submit" value="Enter Room For Appointment" /></div>
								<%end%>	
								
								<form action="/tok/ScheduleAppointment" method= "get"> <!-- Ability to propose a schedule -->
									<input type = "hidden" name = "qID" value = "<%= q.id %>" />
									<input class="btn" type="submit" value="Propose Alternate Schedule" />
								</form>	
							</li>
							<li class="divider"></li>
						<%end%>
						
								
						</ul>
						</div>
					</div>

	</div>
	<div class="tab-pane fade" id="past">
		<ul class="nav nav-list">
					<%if @qPrev.length == 0 && @qPrevAnswer.length == 0%>
						No past conversations...
					<%end%>
					<% @qPrev.each do |q| %>
					<span class="questions"><%=q.question%></span>
						<%user = User.find(q.answer_id)%>
						<%name = user.firstName + " " + user.lastName%>
						with <a class="question-username" href="/bio?id=<%=q.answer_id%>"><%=name%></a><br>
						<div class="notes-exp">
							<div class="wd-expando notes-collapse">
								<h2>Notes</h2>
								<ul>
									<%if !q.notes.nil?%>
										<li><p style="word-wrap:break-word;"><%=q.notes.html_safe%></p></li>
									<%end%>
								</ul>
							</div>
						</div>
						<form action="/tok/delete" method= "get">
							<input type = "hidden" name = "qID" value = "<%= q.id %>" />
							<input class="btn" type="submit" value="Delete Question" />
						</form>	
					</li>
					<li class="divider"></li>
					<%end%>
				</ul>

				<ul class="nav nav-list">
					<% @qPrevAnswer.each do |q| %>
					<li><span class="questions"><%=q.question%></span>
						<%user = q.user%>
						<%name = user.firstName + " " + user.lastName%>
						with <a class="question-username" href="/bio?id=<%=q.user.id%>"><%=name%></a><br>
						<div class="wd-expando notes-collapse">
							<h2>Notes</h2>
							<ul>
								<%if !q.answerer_notes.nil?%>
									<li><p style="word-wrap:break-word;"><%=q.answerer_notes.html_safe%></p></li>
								<%end%>
							</ul>
						</div>
						<form action="/tok/delete" method= "get">
							<input type = "hidden" name = "qID" value = "<%= q.id %>" />
							<input class="btn" type="submit" value="Delete Question" />
						</form>	
					</li>
					<li class="divider"></li>
					<%end%>
				</ul>
			</div>
		</div>

	</div>
</div>

<script type ="text/javascript">
	var times = document.getElementsByName("timeDiv");
	for(i = 0; i < times.length; i++){
		var appointment = times[i];
		appointment.innerHTML = dateFormat(new Date(appointment.innerHTML), 'mmmm dd yyyy hh:MM tt Z');
	}
	
</script>
